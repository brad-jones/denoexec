on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

env:
  CI: true

jobs:
  updatedeno:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: asdf-vm/actions/setup@v1.1.0
      - run: asdf plugin-add deno https://github.com/asdf-community/asdf-deno.git
      - id: from
        run: echo ::set-output name=FROM_VERSION::$(asdf current deno 2>&1 | xargs -n 1 | sed -n '2p')
      - run: asdf install deno latest && asdf local deno latest
      - id: to
        run: echo ::set-output name=TO_VERSION::$(asdf current deno 2>&1 | xargs -n 1 | sed -n '2p')
      - id: changelog
        uses: maxkomarychev/octions/octions/repos/get-release-by-tag@v0.11.0
        with:
          token: ${{ github.token }}
          owner: denoland
          repo: deno
          tag: v${{ steps.to.outputs.TO_VERSION }}
          custom_outputs: |
            body:data.body
      - id: generate_token
        uses: tibdex/github-app-token@v1.3.0
        with:
          app_id: ${{ secrets.BOT_ID }}
          private_key: ${{ secrets.BOT_KEY }}
      - uses: peter-evans/create-pull-request@v3.10.0
        with:
          title: "fix(deps): bump deno from ${{ steps.from.outputs.FROM_VERSION }} to ${{ steps.to.outputs.TO_VERSION }}"
          commit-message: "fix(deps): bump deno from ${{ steps.from.outputs.FROM_VERSION }} to ${{ steps.to.outputs.TO_VERSION }}"
          branch: dependencies/deno
          delete-branch: true
          labels: dependencies
          body: ${{ steps.changelog.outputs.body }}
          token: ${{ steps.generate_token.outputs.token }}

  updatenodejs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: asdf-vm/actions/setup@v1.1.0
      - run: asdf plugin add nodejs https://github.com/asdf-vm/asdf-nodejs.git
      - id: from
        run: echo ::set-output name=FROM_VERSION::$(asdf current nodejs 2>&1 | xargs -n 1 | sed -n '2p')
      - run: asdf install nodejs latest && asdf local nodejs latest
      - id: to
        run: echo ::set-output name=TO_VERSION::$(asdf current nodejs 2>&1 | xargs -n 1 | sed -n '2p')
      - id: changelog
        uses: maxkomarychev/octions/octions/repos/get-release-by-tag@v0.11.0
        with:
          token: ${{ github.token }}
          owner: nodejs
          repo: node
          tag: v${{ steps.to.outputs.TO_VERSION }}
          custom_outputs: |
            body:data.body
      - id: generate_token
        uses: tibdex/github-app-token@v1.3.0
        with:
          app_id: ${{ secrets.BOT_ID }}
          private_key: ${{ secrets.BOT_KEY }}
      - uses: peter-evans/create-pull-request@v3.10.0
        with:
          title: "fix(deps): bump nodejs from ${{ steps.from.outputs.FROM_VERSION }} to ${{ steps.to.outputs.TO_VERSION }}"
          commit-message: "fix(deps): bump nodejs from ${{ steps.from.outputs.FROM_VERSION }} to ${{ steps.to.outputs.TO_VERSION }}"
          branch: dependencies/nodejs
          delete-branch: true
          labels: dependencies
          body: ${{ steps.changelog.outputs.body }}
          token: ${{ steps.generate_token.outputs.token }}
